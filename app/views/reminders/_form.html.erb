<%= form_with model: @reminder, local: true, class: "space-y-6", data: { controller: "form", action: "submit->form#submit" } do |f| %>
  <% if @reminder.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-400 text-red-800 p-4 rounded-lg mb-6" role="alert">
      <div class="flex items-start">
        <svg class="w-5 h-5 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <div class="flex-1">
          <h3 class="font-semibold mb-2"><%= pluralize(@reminder.errors.count, "error") %> prohibited this reminder from being saved:</h3>
          <ul class="list-disc list-inside space-y-1 text-sm">
            <% @reminder.errors.full_messages.each do |message| %>
              <li>
                <% if message.include?("Add one in Settings") %>
                  <% prefix = message.sub(/\s*Add one in Settings\.?\z/, "").strip %>
                  <%= safe_join([prefix, link_to("Add one in Settings", settings_path, class: "underline hover:no-underline font-medium")], " ") %>
                <% else %>
                  <%= message %>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <div>
    <%= f.label :title, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= f.text_field :title, 
        maxlength: 25, 
        class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition #{'border-red-300 focus:ring-red-500 focus:border-red-500' if @reminder.errors[:title].any?}",
        placeholder: "Max 25 characters" %>
    <p class="mt-1.5 text-sm text-gray-500">Required, maximum 25 characters</p>
    <% if @reminder.errors[:title].any? %>
      <p class="mt-1 text-sm text-red-600"><%= @reminder.errors[:title].first %></p>
    <% end %>
  </div>

  <div>
    <%= f.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= f.text_area :description, 
        maxlength: 100, 
        rows: 3,
        class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none #{'border-red-300 focus:ring-red-500 focus:border-red-500' if @reminder.errors[:description].any?}",
        placeholder: "Max 100 characters" %>
    <p class="mt-1.5 text-sm text-gray-500">Required, maximum 100 characters</p>
    <% if @reminder.errors[:description].any? %>
      <p class="mt-1 text-sm text-red-600"><%= @reminder.errors[:description].first %></p>
    <% end %>
  </div>

  <div>
    <%= f.label :started, "Start Date & Time", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= f.datetime_local_field :started, 
        value: @reminder.started&.in_time_zone(current_user.timezone)&.strftime("%Y-%m-%dT%H:%M"),
        class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition #{'border-red-300 focus:ring-red-500 focus:border-red-500' if @reminder.errors[:started].any?}" %>
    <p class="mt-1.5 text-sm text-gray-500">
      Time shown in your timezone: <span class="text-gray-900"><%= current_user.timezone || "UTC (detecting...)" %></span>
      <%= link_to "Update", settings_path, class: "text-gray-500 hover:text-gray-900 ml-1" %>
    </p>
    <% if @reminder.errors[:started].any? %>
      <p class="mt-1 text-sm text-red-600"><%= @reminder.errors[:started].first %></p>
    <% end %>
  </div>

  <div>
    <%= f.label :period, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= f.select :period, 
        options_for_select([
          ['One-time', 'one_off'],
          ['Daily', 'daily'],
          ['Weekly', 'weekly'],
          ['Monthly', 'monthly'],
          ['Quarterly', 'quarterly'],
          ['Yearly', 'yearly']
        ], @reminder.period),
        {},
        { class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white #{'border-red-300 focus:ring-red-500 focus:border-red-500' if @reminder.errors[:period].any?}" } %>
    <% if @reminder.errors[:period].any? %>
      <p class="mt-1 text-sm text-red-600"><%= @reminder.errors[:period].first %></p>
    <% end %>
  </div>

  <div>
    <%= f.label "Delivery Methods", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <div class="space-y-2">
      <div class="flex items-center">
        <%= f.check_box :email_enabled, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
        <%= f.label :email_enabled, "Email", class: "ml-2 text-sm text-gray-700" %>
      </div>
      <div class="flex items-center">
        <%= f.check_box :sms_enabled, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
        <%= f.label :sms_enabled, "Text", class: "ml-2 text-sm text-gray-700" %>
        <% if @reminder.sms_enabled? && !current_user.phone_verified? %>
          <span class="ml-2 text-xs text-amber-600">⚠️ <%= link_to "Verified phone required — add in Settings", settings_path, class: "underline hover:no-underline" %></span>
        <% end %>
      </div>
    </div>
  </div>

  <div class="flex items-center gap-3 pt-4">
    <%= f.submit data: { form_target: "submit" }, class: "inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 rounded-md transition cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" %>
    <%= link_to "Cancel", reminders_path, class: "text-sm text-gray-500 hover:text-gray-900" %>
  </div>
<% end %>

